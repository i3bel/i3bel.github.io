{{- $headers := findRE "<h[1-6].*?>(.|\n])+?</h[1-6]>" .Content -}}
{{- if ge (len $headers) 1 -}}
<div class="toc">
    <details {{if .Param "TocOpen"}} open{{end}}>
        <summary style="list-style: none; -webkit-appearance: none; appearance: none; cursor: pointer;">
            <span class="toc-icon">+</span>
            <span class="details">{{ i18n "toc" | default "Table of Contents" }}</span>
        </summary>

        <div class="inner">
            {{- $largest := 6 -}}
            {{- range $headers -}}
                {{- $level := index (findRE "[1-6]" . 1) 0 -}}
                {{- $level := len (seq $level) -}}
                {{- if lt $level $largest -}}
                    {{- $largest = $level -}}
                {{- end -}}
            {{- end -}}

            {{- $.Scratch.Set "ulstack" slice -}}
            <ul>
            {{- range $i, $header := $headers -}}
                {{- $level := index (findRE "[1-6]" . 1) 0 -}}
                {{- $level := len (seq $level) -}}
                {{- $id := index (findRE "(id=\"(.*?)\")" $header 9) 0 -}}
                {{- $cleanedID := replace (replace $id "id=\"" "") "\"" "" -}}
                {{- $headerText := replaceRE "<h[1-6].*?>((.|\n])+?)</h[1-6]>" "$1" $header -}}

                {{- if ne $i 0 -}}
                    {{- $prevLevel := index (findRE "[1-6]" (index $headers (sub $i 1)) 1) 0 -}}
                    {{- $prevLevel := len (seq $prevLevel) -}}

                    {{- if gt $level $prevLevel -}}
                        {{- range seq $prevLevel (sub $level 1) -}}
                            <ul>{{/* 新增子列表 */}}
                            {{- $.Scratch.Add "ulstack" . -}}
                        {{- end -}}
                    {{- else if lt $level $prevLevel -}}
                        {{- range seq (sub $prevLevel 1) -1 $level -}}
                            {{- if in ($.Scratch.Get "ulstack") . -}}
                                </ul>
                                {{- $tmp := $.Scratch.Get "ulstack" -}}
                                {{- $.Scratch.Delete "ulstack" -}}
                                {{- $.Scratch.Set "ulstack" slice -}}
                                {{- range seq (sub (len $tmp) 1) -}}
                                    {{- if ne (index $tmp .) . -}}
                                        {{- $.Scratch.Add "ulstack" (index $tmp .) -}}
                                    {{- end -}}
                                {{- end -}}
                            {{- end -}}
                        {{- end -}}
                    {{- else -}}
                        </li>
                    {{- end -}}
                {{- end -}}

                <li style="margin-left: {{ mul (sub $level $largest) 1.5 }}em;">
                    <a href="#{{ $cleanedID }}" aria-label="{{ $headerText | plainify }}">{{ $headerText | plainify }}</a>
            {{- end -}}

            {{- /* close remaining ul */ -}}
            {{- range seq 0 (len ($.Scratch.Get "ulstack")) -}}
                </ul></li>
            {{- end -}}
            </ul>
        </div>
    </details>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    // TOC summary 符号切换
    document.querySelectorAll(".toc summary").forEach(function(summary) {
        var icon = summary.querySelector(".toc-icon");
        icon.textContent = summary.parentNode.open ? "−" : "+";

        summary.addEventListener("click", function() {
            setTimeout(function() {
                icon.textContent = summary.parentNode.open ? "−" : "+";
            }, 0);
        });
    });
});
</script>
{{- end }}
